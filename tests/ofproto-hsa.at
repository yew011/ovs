AT_BANNER([ofproto-hsa])

# simple infinit loop.
AT_SETUP([ofproto-hsa - loop detect 1])
OVS_VSWITCHD_START(
  [add-port br0 p1 -- set int p1 type=dummy ofport_request=1])

# should have only two lines of output, one for each output action.
AT_DATA([flows.txt], [dnl
table=0,priority=3,in_port=1,ip,nw_src=10.1.0.0/255.255.0.0,actions=resubmit(,1)
table=1,in_port=1,ip,nw_dst=20.2.0.0/255.255.0.0,actions=resubmit(,0)
])

AT_CHECK([ovs-ofctl add-flows br0 flows.txt])

AT_CHECK([ovs-appctl hsa/detect-loop br0 | sed -n '/OUTPUT/,$p'], [0], [dnl
OUTPUT
======
Loop Path (Infinite Loop)
=========
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)
table_id=1, ip,in_port=1,nw_dst=20.2.0.0/16,actions=resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=resubmit(,1)

])

OVS_VSWITCHD_STOP
AT_CLEANUP

# finite loop.
AT_SETUP([ofproto-hsa - loop detect 1])
OVS_VSWITCHD_START(
  [add-port br0 p1 -- set int p1 type=dummy ofport_request=1])

# should have only two lines of output, one for each output action.
AT_DATA([flows.txt], [dnl
table=0,priority=3,in_port=1,ip,nw_src=10.1.0.0/255.255.0.0,actions=2,resubmit(,1)
table=1,priority=2,in_port=1,reg3=0xffff,actions=resubmit(,3)
table=1,priority=1,in_port=1,ip,nw_dst=20.2.0.0/255.255.0.0,actions=load:0xffff->NXM_NX_REG2[[0..15]],resubmit(,2)
table=2,in_port=1,reg2=0xffff,actions=load:0xffff->NXM_NX_REG3[[0..15]],resubmit(,0)
table=3,in_port=1,actions=output:3
])

AT_CHECK([ovs-ofctl add-flows br0 flows.txt])

AT_CHECK([ovs-appctl hsa/detect-loop br0 | sed -n '/OUTPUT/,$p'], [0], [dnl
OUTPUT
======
Loop Path (Finite Loop)
=========
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=output:2,resubmit(,1)
table_id=1, priority=1,ip,in_port=1,nw_dst=20.2.0.0/16,actions=load:0xffff->NXM_NX_REG2[[0..15]],resubmit(,2)
table_id=2, reg2=0xffff,in_port=1,actions=load:0xffff->NXM_NX_REG3[[0..15]],resubmit(,0)
table_id=0, priority=3,ip,in_port=1,nw_src=10.1.0.0/16,actions=output:2,resubmit(,1)
table_id=1, priority=2,reg3=0xffff,in_port=1,actions=resubmit(,3)

])

OVS_VSWITCHD_STOP
AT_CLEANUP

# finite loop.
AT_SETUP([ofproto-hsa - unused detect 1])
OVS_VSWITCHD_START(
  [add-port br0 p1 -- set int p1 type=dummy ofport_request=1])

# should have only two lines of output, one for each output action.
AT_DATA([flows.txt], [dnl
table=0,priority=3,in_port=1,ip,nw_src=10.1.0.0/255.255.0.0,actions=2,resubmit(,1)
table=0,priority=1,in_port=1,reg5=0x1234,tcp,nw_src=10.1.0.0/255.255.0.0,tp_src=10,actions=2,resubmit(,1)
table=1,priority=2,in_port=1,reg3=0xffff,actions=resubmit(,3)
table=1,priority=1,in_port=1,ip,nw_dst=20.2.0.0/255.255.0.0,actions=load:0xffff->NXM_NX_REG2[[0..15]],resubmit(,2)
table=2,in_port=1,reg2=0xffff,actions=load:0xffff->NXM_NX_REG3[[0..15]],resubmit(,0)
table=3,in_port=1,actions=output:3
])

AT_CHECK([ovs-ofctl add-flows br0 flows.txt])

AT_CHECK([ovs-appctl hsa/detect-unused br0 | sed -n '/OUTPUT/,$p'], [0], [dnl
OUTPUT
======
UNUSED FLOWS
============
table_id=0, priority=1,tcp,reg5=0x1234,in_port=1,nw_src=10.1.0.0/16,tp_src=10,actions=output:2,resubmit(,1)

])

OVS_VSWITCHD_STOP
AT_CLEANUP